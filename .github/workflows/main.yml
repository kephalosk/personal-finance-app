name: build, push, scan and deploy

on:
  push:
    branches: 
      - '*'

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master
        uses: actions/checkout@main

      - name: Install Dependencies
        run: |
         cd frontend
         npm install

      - name: Run Unit Tests
        run: |
         cd frontend
         npm run test
  
  build:
    runs-on: ubuntu-latest

    needs: unit-tests

    steps:
    - name: Checkout master
      uses: actions/checkout@main
      
    - name: Build container image
      run: docker build -t registry.digitalocean.com/kephalosk/personal-finance-app:latest -f deployment/Dockerfile .

    - name: Install doctl
      if: github.ref == 'refs/heads/master'
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry with short-lived credentials
      if: github.ref == 'refs/heads/master'
      run: doctl registry login --expiry-seconds 1200
      
    - name: Push image to DigitalOcean Container Registry
      if: github.ref == 'refs/heads/master'
      run: docker push registry.digitalocean.com/kephalosk/personal-finance-app:latest
      
  scan:
    runs-on: ubuntu-latest

    needs: build

    continue-on-error: true

    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          
      - name: Log in to DigitalOcean Container Registry with short-lived credentials
        run: doctl registry login --expiry-seconds 1200
        
      - name: Pull image from registry
        run: docker pull registry.digitalocean.com/kephalosk/personal-finance-app:latest

      - name: Authenticate GitHub Container Registry
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
      - name: Set up Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -

      - name: Set TRIVY_DBREPO to avoid rate limiting
        run: echo "TRIVY_DBREPO=ghcr.io/aquasecurity/trivy-db" >> $GITHUB_ENV

      - name: Scan Docker Image
        run: ./bin/trivy image --exit-code 1 --severity HIGH,CRITICAL registry.digitalocean.com/kephalosk/personal-finance-app:latest

  deploy:
    runs-on: ubuntu-latest
    
    needs: scan

    if: github.ref == 'refs/heads/master'

    steps:
    - name: Checkout master
      uses: actions/checkout@main

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry with short-lived credentials
      run: doctl registry login --expiry-seconds 1200

    - name: Renew clusterâ€™s certificate
      run: doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_ID }}

    - name: Deploy to DigitalOcean Kubernetes
      run: kubectl apply -f deployment/personal-finance-app.yaml
        
    - name: restart Pods
      run: kubectl -n default rollout restart deploy

    - name: Verify deployment
      run: kubectl rollout status deployment/personal-finance-app

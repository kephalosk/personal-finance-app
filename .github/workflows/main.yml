name: build, push, and deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master
        uses: actions/checkout@main
  
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  
      - name: Build container image
        run: docker build -t registry.digitalocean.com/kephalosk/personal-finance-app:latest -f deployment/Dockerfile .
  
      - name: Log in to DigitalOcean Container Registry with short-lived credentials
        run: doctl registry login --expiry-seconds 1200
        
      - name: Push image to DigitalOcean Container Registry
        run: docker push registry.digitalocean.com/kephalosk/personal-finance-app:latest
  
      - name: Renew clusterâ€™s certificate
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_ID }}
  
      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f deployment/personal-finance-app.yaml
          
      - name: restart Pods
        run: kubectl -n default rollout restart deploy
  
      - name: Verify deployment
        run: kubectl rollout status deployment/personal-finance-app

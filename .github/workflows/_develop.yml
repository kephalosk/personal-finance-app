name: versioning, tests, build, image-scans, code-scans, linting, ui-tests and notifying

on:
  push:
    branches:
      - 'develop'

permissions:
  security-events: write
  checks: write

jobs:
  versioning:
    uses: ./.github/workflows/stage1_versioning.yml

  tests:
    uses: ./.github/workflows/stage2_tests.yml
    needs: versioning
    secrets: inherit

  build:
    uses: ./.github/workflows/stage3_build.yml
    needs: tests
    secrets: inherit

  image-scans:
    uses: ./.github/workflows/stage4_image-scans.yml
    needs: build
    secrets: inherit

  code-scans:
    uses: ./.github/workflows/stage5_code-scans.yml
    needs: image-scans
    secrets: inherit

  linting2:
    uses: ./.github/workflows/stage6_linting.yml
    needs: code-scans
    secrets: inherit

  ui-tests:
    uses: ./.github/workflows/stage7_ui-tests.yml
    needs: linting2
    secrets: inherit

  send-notification-success:
    runs-on: ubuntu-latest

    needs: ui-tests

    steps:
      - name: Send Email via SendGrid
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "CI/CD develop - Success - philippkraatz.com - Notification"
          body: |
            Pipeline erfolgreich durchgelaufen fÃ¼r Repository **${{ github.repository }}**! ðŸŽ‰

            Commit: ${{ github.event.head_commit.message }}
            Autor: ${{ github.event.head_commit.author.name }}

            Repository: github.com/kephalosk/personal-finance-app
            Action Logs: github.com/kephalosk/personal-finance-app/actions

  send-notification-failure:
    runs-on: ubuntu-latest

    needs: ui-tests
    if: always() && needs.ui-tests.result == 'failure'

    steps:
      - name: Send Email via SendGrid
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "CI/CD develop - Failure - philippkraatz.com - Notification"
          body: |
            Pipeline abgebrochen fÃ¼r Repository **${{ github.repository }}**! ðŸŽ‰

            Commit: ${{ github.event.head_commit.message }}
            Autor: ${{ github.event.head_commit.author.name }}

            Repository: github.com/kephalosk/personal-finance-app
            Action Logs: github.com/kephalosk/personal-finance-app/actions

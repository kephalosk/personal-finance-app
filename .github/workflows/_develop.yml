name: versioning, tests, build, image-scans, code-scans, linting, ui-tests and notifying

on:
  push:
    branches:
      - 'develop'

permissions:
  security-events: write
  checks: write

jobs:
  versioning:
    uses: ./.github/workflows/stage1_versioning.yml

  testing:
    uses: ./.github/workflows/stage2_testing.yml
    needs: versioning
    secrets: inherit

  building:
    uses: ./.github/workflows/stage3_building.yml
    needs: testing
    secrets: inherit

  image-analyzing:
    uses: ./.github/workflows/stage4_image-analyzing.yml
    needs: building
    secrets: inherit

  code-analyzing:
    uses: ./.github/workflows/stage5_code-analyzing.yml
    needs: image-analyzing
    secrets: inherit

  linting2:
    uses: ./.github/workflows/stage6_linting.yml
    needs: code-analyzing
    secrets: inherit

  ui-testing:
    uses: ./.github/workflows/stage7_ui-testing.yml
    needs: linting2
    secrets: inherit

  send-notification-success:
    runs-on: ubuntu-latest

    needs: ui-testing

    steps:
      - name: Send Email via SendGrid
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "CI/CD develop - Success - philippkraatz.com - Notification"
          body: |
            Pipeline erfolgreich durchgelaufen fÃ¼r Repository **${{ github.repository }}**! ðŸŽ‰

            Commit: ${{ github.event.head_commit.message }}
            Autor: ${{ github.event.head_commit.author.name }}

            Repository: github.com/kephalosk/personal-finance-app
            Action Logs: github.com/kephalosk/personal-finance-app/actions

  send-notification-failure:
    runs-on: ubuntu-latest

    needs: ui-testing
    if: always() && needs.ui-testing.result == 'failure'

    steps:
      - name: Send Email via SendGrid
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "CI/CD develop - Failure - philippkraatz.com - Notification"
          body: |
            Pipeline abgebrochen fÃ¼r Repository **${{ github.repository }}**! ðŸŽ‰

            Commit: ${{ github.event.head_commit.message }}
            Autor: ${{ github.event.head_commit.author.name }}

            Repository: github.com/kephalosk/personal-finance-app
            Action Logs: github.com/kephalosk/personal-finance-app/actions
